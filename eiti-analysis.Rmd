---
title: "DRC - Analysis"
author: "Thomas Lassourd"
date: 'Date created: `r Sys.Date()`'
output:
  html_notebook:
    df_print: paged
    highlight: haddock
    smart: yes
    theme: readable
  html_document:
    code_folding: hide
    df_print: paged
  pdf_document: default
---
## {.tabset}

### Purpose
Cleaning and analyzing EITI data for the Democratic Republic of Congo.

We source EITI data from www.resourcedata.org, which itselfs aggregates EITI summary data in open data format shared by the international EITI secretariat here: https://eiti.org/explore-data-portal  

#### Warning: this webpage is a work in progress, shared for limited consultations only. Please keep in mind that the data may require additional cleaning. There could be errors in the EITI summary data, if not in the EITI reports themselves.The formatting of the plots is also tentative and will be refined at a later stage.

#### We welcome all comments on the data sourced, the cleaning process, and preliminary plot analysis. Please email Thomas Lassourd <tlassourd@resourcegovernance.org> or Jean Pierre Okenda <jpokenda@resourcegovernance.org>.    

```{r message=FALSE}
pacman::p_load(tidyverse, ggthemes, nrgiR , scales)

## get the EITI company data from resource data (only downloads once a session)
if (!exists("eiti_company")) {
  eiti_company <- read_csv("https://www.resourcedata.org/dataset/7dd3c8b6-9256-4e34-9360-1519efd87407/resource/bba3b646-131b-47c5-9f4c-37019f896575/download/company-payments.csv")
}
```

Now that we have the data ready let's do some clean up.

### Cleaning

We are only interested in data from DRC. Let's narrow down the selection and clean the company names, the gfs codes, the gfs descriptions and the name of the revenue streams, using specifically made files (available upon request, or in the Github repository: https://github.com/ThomasNRGI/EITI_DRC).

The cleaning process requires some decisions and assumptions regarding project / company names and categorizations of revenue stream by gfs description. Here are some of the main choices we have made on company (project) names:

+ When projects are also reporting under mandatory listing disclosure rules, the project name in resourceprojects.org was chosen, if compatible.
+ When project names have changed, we use the most recent project name for all years in the data.
+ When projects have merged, we attribute the latest project name to the separate projects prior to the merger. E.g. payments from DCK and KOL, which merged and created KCC in 2008, are attributed to KCC. Payments from Kanuski are attributed to Mutanda.
+ We added a column "additional company name" to provide more data where relevant (name of company in mandatory disclosure reporting, majority owner, historic project names, etc.)
+ Anvil Mining Congo ( AMC) and MMG Kinsevere (MMG) are separate projects.

Here are some of the main choices we have made on gfs description and gfs codes:

+ Every revenue stream to state-owned companies was included in the category gfs code 1415E32 / gfs description: "Delivered/paid to state-owned enterprise(s)", regardless of the type of revenue. This includes bonus (pas-de-porte), royalties, dividend payments, equity sales (cessions de parts sociales), rent payments (loyers d'amodiation et/ou rente mensuelle), sale of tailings by GCM (Fonds versés a la GCM pour la vente des scories), additional royalty (redevance supplémentaires sur les réserves additionnelles), advances on future dividend and royalty payments (avance contractuelle sur dividendes ou royalties futurs), consulting fees (frais de consultance), sale of mining licenses (vente de Licence), fee for abandonning prehemption rights (frais de renonciation au droit de préemption).
Note: According to article 25 of the law on privatization (http://www.droit-afrique.com/upload/doc/rdc/RDC-Loi-2008-08-desengagement-Etat-dans-entreprises-publiques.pdf), state equity sales should be collected by the Treasury, but in practice SOEs have been collecting them, as evidenced in EITI company reporting, so we categorize them here as payments to SOEs. 
+ Other re-categorizations can be found in the "reconcile" excel sheet.


```{r message=FALSE}
## We import the reconciliation files in excel into a dataframe (made from initially extracting all unique occurences of company names and names of revenue streams, matching them to clean names and adding a sector variable (mining vs oil))
company_reconcile <- readxl::read_excel("reconcile.xlsx", sheet = "company_names") %>% 
  mutate(company_name_clean = str_squish(company_name_clean)) %>%
  distinct()

rev_code_reconcile <- readxl::read_excel("reconcile.xlsx", sheet = "rev_codes") %>% 
  mutate(gfs_code_clean = str_squish(gfs_code_clean) , 
         gfs_description_clean = str_squish(gfs_description_clean) ,
         name_of_revenue_stream_clean = str_squish(name_of_revenue_stream_clean) ) %>%
  distinct()

## We filter eiti summary data for DRC specifically, we add the clean columns for the company names, the gfs codes, the gfs descriptions and the name of the revenue streams and then delete the original variables.
drc_eiti <- eiti_company %>% 
  filter(country == "Democratic Republic of Congo") %>% 
  left_join(., rev_code_reconcile, by = "name_of_revenue_stream") %>% 
  left_join(., company_reconcile, by = "company_name") %>% 
     mutate(company_name = company_name_clean, 
            gfs_code = gfs_code_clean, 
            gfs_description = gfs_description_clean,
            name_of_revenue_stream = name_of_revenue_stream_clean) %>%
  select ( -c( company_name_clean , gfs_code_clean, gfs_description_clean ,  name_of_revenue_stream_clean)) 

```

### Create functions for sorting observations

#### Designing the functions
In the code below we create a function that takes the tibble, the grouping variable and a threshold as its arguments. This automates the same logic that we will be repeating across different charts. 

```{r message=FALSE}
get_plot_data <- function(df, g_var, threshold) {
  df %>% 
    filter(sector == "Mining") %>% 
    group_by({{g_var}}) %>% 
    mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
    ungroup() %>% 
    mutate(x_var = if_else(total_pay > threshold, {{g_var}}, "Other")) %>%
    group_by(x_var) %>% 
    summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
    ungroup()
}

get_plot_data_2 <- function(df, g_var, h_var, threshold) {
  df %>% 
    filter(sector == "Mining") %>% 
    group_by({{g_var}}) %>% 
    mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
    ungroup() %>% 
    mutate(x_var = if_else(total_pay > threshold, {{g_var}}, "Other")) %>%
    group_by(x_var , {{h_var}}) %>% 
    summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
    ungroup()
}

```



### Visual description of the data
The data is ready for some simple descriptive analysis. 

The first chart shows us the total amount of payment by year. 

Comment: large drop in mining revenue in 2016. Does it conform to EITI reports and other data points?

Comment: add number of companies reporting per year, range of payments, etc.

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year, y = total_pay)) +
    geom_col() +
    theme_fivethirtyeight() +
    scale_y_continuous(labels = unit_format(accuracy = 0.1 , unit = "bn. USD", scale = 1e-9 , sep = " ")) +
    labs(title ="Total annual contributions according to EITI summary data", x = "year", y = "Cumulative payments")
```

The second chart shows us the mining companies that pay more than a threshold of 180 million USD over the entire period covered by the database.

Comment: the majority of payments made during that period comes from 12 companies
````{r, fig.width=12}
get_plot_data( drc_eiti, company_name , threshold = 18e7) %>% 
  ggplot(data = ., mapping = aes(x = fct_reorder(x_var, -total_pay), y = total_pay)) +
  geom_col() +
  coord_flip() +
  theme_economist() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(accuracy = 0.1 , unit = "bn. USD", scale = 1e-9, sep = " ")) +
  labs(title = "Top mining taxpayers's total contributions according to EITI reports", 
       y = "Cumulative payments") +
  theme(
    axis.title.y = element_blank()
  ) 

```



The third chart shows us the mining companies that pay more than a threshold of 180 million USD over the entire period covered by the database.

Comment: Sicomines and SEK only make it in the top 12 because of large payments in specific years, 2012 and 2014 respectively.
```{r, fig.width=12}
get_plot_data_2(drc_eiti, g_var = company_name, h_var = year , threshold = 18e7) %>%
  ggplot(data = ., mapping = aes(x = as.factor(year), y = total_pay)) + 
    geom_col() +
    facet_wrap(~fct_reorder(str_wrap(x_var, width = 10), total_pay), nrow = 1) +
    scale_x_discrete( ) +
    scale_y_continuous(labels = unit_format(accuracy = 1 , unit = "milion USD", scale = 1e-6 , sep = " ")) +
    theme(axis.text.x = element_text(angle = 90)) +
    labs(title ="Top mining taxpayers's annual contributions according to EITI summary data", x = "year", y = "Total annual payments" , facet_wrap = "Companies")
```


The fourth chart shows us the major payment types, by gfs description, that contributed more than 120 million USD over the entire period covered by the database.

Note: royalties are royalties to the State ("redevance"). Royalties to SOEs are categorized within "paid to state-owned enterprises".

Comments: 

1. Surprisingly custom payments come out first, while one would expect it to be lower, based on cash flow models.
2. Payments to SOEs is the second largest payment. 
```{r, fig.width=12}
get_plot_data( drc_eiti, gfs_description , threshold = 12e7) %>% 
  ggplot(aes(x = fct_reorder(x_var, -total_pay), y = total_pay)) +
  geom_col() +
  coord_flip() +
  theme_economist() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  scale_y_continuous(labels = unit_format(accuracy = 0.1 , unit = "bn. USD", scale = 1e-9, sep = " ")) +
  labs(title ="Main revenue streams from mining according to EITI summary data", x = "", y = "Cumulative payments - USD")
```

The fifth chart shows us the major payment types, by gfs description, that contributed more than 120 million USD over the entire period covered by the database, on an annual basis.

Comments:

1. Custom duties are really high from 2013 to 2015.
2. Large bonus payment in 2012 (Sicomines)
3. Taxes on income are important in later years 2014-16, though only really high in 2015, even though 2015 saw a drop in copper prices.
4. Fines are a non-insignificant source of revenue. Questions tax policy and administration efficiency / governance.
```{r, fig.width=12}
get_plot_data_2(drc_eiti, g_var = gfs_description, h_var = year , threshold = 12e7) %>%
  ggplot(data = ., mapping = aes(x = as.factor(year), y = total_pay)) + 
    geom_col() +
    facet_wrap(~fct_reorder(str_wrap(x_var, width = 10), total_pay), nrow = 1) +
    scale_x_discrete( ) +
    scale_y_continuous(labels = unit_format(accuracy = 1 , unit = "milion USD", scale = 1e-6 , sep = " ")) +
    theme(axis.text.x = element_text(angle = 90)) +
    labs(title ="Main revenue streams according to EITI summary data", x = "year", y = "Total annual payments" , facet_wrap = "Revenue categories")

```

### Advanced visual description of the data

The sixth chart shows us the major gfs description of the payments of the mining companies that pay more than a threshold of 180 million USD over the entire period covered by the database.

Comments:

1. Mutanda, KCC, TFM and Kibali pay a lot of custom duties: need to investigate.
2. KCC, Metalkol, TFM, Ruashi, Kinsevere, SEK, and Mutanda pay significant amount to SOEs.
3. Very large bonus payments from Sicomines and Frontier.
4. Very little royalties paid by Metalkol and Sicomines. 
```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 18e7, company_name, "Other")) %>% 
  group_by(gfs_description) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(gfs_description = if_else(total_pay > 12e7, gfs_description, "Other")) %>% 
  group_by(company_name, gfs_description) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = fct_reorder(company_name, -total_pay), y = total_pay, fill = gfs_description)) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(accuracy = 0.1 , unit = "bn. USD", scale = 1e-9, sep = " ")) +
  labs(title ="Top mining taxpayers's total contributions by main gfs description according to EITI summary data", x = "Companies", y = "Cumulative payments")
```

The seventh chart shows us the mining companies that pay more than a threshold of 20 million USD of customs payments over the entire period covered by the database.

Comments:

1.  Confirms that KCC, Mutanda, TFM and Kibali have paid very large sums in custom duties. Need to look into it. Possible explanations: fuel imports and other inputs?
```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining" ,
         gfs_description == "Customs and other import duties"
         ) %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 1e7, company_name, "Other")) %>% 
  group_by(company_name, gfs_description) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = fct_reorder(company_name, -total_pay), y = total_pay, fill = gfs_description)) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Top mining payers of custom duties according to EITI summary data", x = "Companies" , y = "Cumulative payments", fill="")
```

The eigth and ninth and tenth charts show us the details of the SOE payments by company and by year.

Comments:

1. Equity sales are the first reveue flow to SOEs, followed by Royalties and Pas de Porte (bonuses)
2. KCC is by far the largest payer to SOEs, followed by Mutanda only because of a large equity sale in 2011.
3. PAs de porte were the highest between 2010 and 2012
4. Frais de consultance only show up from TFM and Mutanda. But are very regular payments between 2013 and 2016. 
5. Fonds pour la vente des scories (payments to GCM for deposit sales) only show up from STL and Rubamin. But are significant payment from 2013 to 2016.
6. SOEs receive annually between 60 and 180 million USD in total payments from mining companies, or between 100 and 300 million USD if we had revenue collected from equity sales.
7. Loyers d'amodiation / rente mensuelle is only a significan payment from MMG Kinsevere, and particulary high in 2012. 
8. Very large revenue from equity sales from Mutanda (2011), SEK (2014), Congo Dongfang mining company (2015) and Metalkol (2016).
```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining" ,
         gfs_description == "Delivered/paid to state-owned enterprise(s)"
         ) %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 1e7, company_name, "Other")) %>% 
  group_by(company_name, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = fct_reorder(company_name, -total_pay), y = total_pay, fill = name_of_revenue_stream)) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Top mining payers to SOEs according to EITI summary data", x = "Companies" , y = "Cumulative payments", fill = "Revenue stream")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining" ,
         gfs_description == "Delivered/paid to state-owned enterprise(s)"
         ) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments to SOEs according to EITI summary data", y = "Annual payments")
```
```{r, fig.width=12}
drc_eiti %>% 
    filter(sector == "Mining" ,
         name_of_revenue_stream == "Cession d'actifs ou parts sociales"
         ) %>%  
  group_by(company_name, year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = total_pay, fill = fct_reorder(company_name, total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Revenue from equity sales by company according to EITI summary data", x = "year", y = "annual revenue from equity sales", fill = "Companies") +
  theme(
  )
```

The eleventh and twelth charts show us the details of the payments from the gfs category Ordinary taxes on income, profits and capital gains by company and by year.

Comments:

1.  TFM and Mutanda pay by far the most income tax.
2.  Companies pay very little witholding tax on dividends (impot mobilier), except KCC and Mutanda.
3.  Income tax payments have been rapidly increasing between 2012 and 2015, with a sharp drop in 2016. Is it linked to specific events at TFM and Mutanda or the consequence of falling copper prices?
```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining" ,
         gfs_description == "Ordinary taxes on income, profits and capital gains"
         ) %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 1e7, company_name, "Other")) %>% 
  group_by(company_name, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = company_name, y = total_pay, fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Top mining payers in ordinary taxes on income, profits and capital gains  according to EITI summary data", x = "Companies", y = "Cumulative payments" , fill = "Name of revenue stream" )
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining" ,
         gfs_description == "Ordinary taxes on income, profits and capital gains"
         ) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments of ordinary taxes on income, profits and capital gains according to EITI summary data", y = "Annual payments" , fill = "Name of revenue stream")
```

The thirteenth chart in facet wrap shows us the major gfs description of the payments of the mining companies that pay more than a threshold of 180 million USD each year covered by the database.

Comments:

1. KCC's payments almost stop in 2016
2. Companies that have a "normal" payment profile over time: Boss, MMG, Ruashi, Kibali.
3. TFM: exceptionnally large income tax payment in 2015
4. SEK Kipoi: exceptionnally large payment in 2014: equity sale
5. Mutanda: exceptionnally large income tax payment in 2011 and 2015
6. Meltalkol: exceptionnally large income tax payment in 2016
```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 18e7, company_name, "Other")) %>% 
  group_by(gfs_description) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(gfs_description = if_else(total_pay > 12e7, gfs_description, "Other")) %>% 
  group_by(company_name, gfs_description , year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = total_pay, fill = fct_reorder(gfs_description, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  facet_wrap(~str_wrap(company_name , width = 20)) +
  labs(title ="Top mining taxpayers's total contributions by main gfs description according to EITI summary data", y = "Total annual payments")
```

The fourteenth chart in facet wrap shows us how much payments are made in each gfs category each year by the mining companies that pay more than a threshold of 180 million USD each year covered by the database.

Comments:

1. Mutanda's a one-off payment in 2011 stands out.
3. Taxes on exports are just a little lower than royalties, but have no basis in the mining code
4. Custom duties in 2013-2015 seem disproportionate. 
5. Taxes on income show an exceptionnally large payment in 2015.
```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 18e7, company_name, "Other")) %>% 
  group_by(gfs_description) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(gfs_description = if_else(total_pay > 12e7, gfs_description, "Other")) %>% 
  group_by(company_name, gfs_description , year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = total_pay, fill = fct_reorder(company_name, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  facet_wrap(~str_wrap(gfs_description , width = 20)) +
  labs(title ="Annual payments by gfs description of the top mining taxpayers naccording to EITI summary data", y = "Total annual payments")
```

### Company deep dive
We look at the payment structure of some of the major companies reporting in DRC:

#### 1/ Banro
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Banro Corporation") %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e6, name_of_revenue_stream, "Other")) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments of Banro according to EITI summary data", y = "Annual payments" , fill = "Name of revenue stream")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Banro Corporation") %>% 
    group_by(year, company_name) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(company_name, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments of Banro by project according to EITI summary data", y = "Annual payments", fill = "Companies")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(year == "2016" ,
         Additional_company_name == "Banro Corporation"
         ) %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e6, name_of_revenue_stream, "Other")) %>% 
  group_by(company_name, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = company_name , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(accuracy = 1, unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="2016 payments of Banro by project according to EITI summary data", x = "Projects" , y = "2016 payments" ,fill = "Name of revenue stream" )
```

#### 2/ Glencore PLC
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Glencore PLC") %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 40e6, name_of_revenue_stream, "Other")) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments of Glencore PLC according to EITI summary data", y = "Annual payments",fill = "Name of revenue stream")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Glencore PLC") %>% 
    group_by(year, company_name) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(company_name, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments of Glencore PLC by project according to EITI summary data", y = "Annual payments",fill = "Projects")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(year == "2016" ,
         Additional_company_name == "Glencore PLC"
         ) %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e6, name_of_revenue_stream, "Other")) %>% 
  group_by(company_name, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = company_name , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title = str_wrap("2016 payments of Glencore PLC by project according to EITI summary data", width = 70), x = "Projects", y = "2016 payments", fill = "Name of revenue stream")
```

#### 3/ Eurasian Resource Group
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Eurasian Resources Group") %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 40e6, name_of_revenue_stream, "Other")) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title = str_wrap( "Annual payments of Eurasian Resources Group according to EITI summary data", width = 60), y = "Annual payments", fill = "Name of revenue stream")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Eurasian Resources Group") %>% 
    group_by(year, company_name) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(company_name, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments of Eurasian Resources Group by project according to EITI summary data", y = "Annual payments" , fill = "Projects")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(year == "2016" ,
         Additional_company_name == "Eurasian Resources Group"
         ) %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e6, name_of_revenue_stream, "Other")) %>% 
  group_by(company_name, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = company_name , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title = str_wrap("2016 payments of Eurasian Resources Group by project according to EITI summary data", width = 60), x = "Projects" , y = "2016 payments", fill = "Name of revenue stream")
```

#### 4/ Ivanhoe Mines Limited
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Ivanhoe Mines Limited") %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e6, name_of_revenue_stream, "Other")) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title = str_wrap("Annual payments of Ivanhoe Mines Limited according to EITI summary data", width = 70), y = "Annual payments" , fill = "Name of revenue stream")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Ivanhoe Mines Limited") %>% 
    group_by(year, company_name) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(company_name, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments of Ivanhoe Mines Limited by project according to EITI summary data", y = "Annual payments", fill = "Projects")
```
```{r, fig.width=12}
drc_eiti %>% 
  filter(year == "2016" ,
         Additional_company_name == "Ivanhoe Mines Limited"
         ) %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e5, name_of_revenue_stream, "Other")) %>% 
  group_by(company_name, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = company_name , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title =str_wrap("2016 payments of Ivanhoe Mines Limited by project according to EITI summary data", width = 70), x = "Projects", y = "2016 payments", fill = "Name of revenue stream")
```

```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Ivanhoe Mines Limited") %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e6, name_of_revenue_stream, "Other")) %>% 
  group_by(company_name, year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  facet_wrap(~company_name) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title = str_wrap("Annual payments of Ivanhoe Mines Limited by project and revenue stream according to EITI summary data", 60), y = "Annual payments", fill = "Projects")
```


#### 5/ TFM
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Lundin Mining Corporation") %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 5e7, name_of_revenue_stream, "Other")) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title = str_wrap("Annual payments of TFM according to EITI summary data", width = 70), y = "Annual payments" , fill = "Name of revenue stream")
```

#### 6/ Alphamin Resources Corporation
Note: only 2016 data is available. Alphamin only owns one project in DRC.
```{r, fig.width=12}
drc_eiti %>% 
  filter(year == "2016" ,
         Additional_company_name == "Alphamin Resources Corporation"
         ) %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e5, name_of_revenue_stream, "Other")) %>% 
  group_by(company_name, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = company_name , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(accuracy = 0.1 , unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title = str_wrap("2016 payments of Alphamin Resources Corporation Bisie Tin project according to EITI summary data",  width = 70), x = "" , y = "2016 payments" , fill = "Name of revenue stream")
```

#### 7/ Barrick Gold (Holdings) Limited (formerly Randgold Resources Limited)
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Barrick Gold (Holdings) Limited (formerly Randgold Resources Limited)") %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e3, name_of_revenue_stream, "Other")) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "thousand USD", scale = 1e-3, sep = " ")) +
  labs(title = str_wrap("Annual payments of Randgold/Barrick according to EITI summary data", width = 70), y = "Annual payments" , fill = "Name of revenue stream")
```

#### 8/ Loncor Resources Congo
```{r, fig.width=12}
drc_eiti %>% 
  filter(Additional_company_name == "Loncor Resources Congo") %>% 
  group_by(name_of_revenue_stream) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(name_of_revenue_stream = if_else(total_pay > 1e3, name_of_revenue_stream, "Other")) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "thousand USD", scale = 1e-3, sep = " ")) +
  labs(title = str_wrap("Annual payments of Loncor according to EITI summary data", width = 70), y = "Annual payments" , fill = "Name of revenue stream")
```

### Payments to different government agencies

We look at payments to different government agencies - especially for SOE payments. This requires to look at the EITI summary data from the perspective of collecting agencies. So we download a different eiti summary data, containing government agencies that received extractive revenue. We clean that data and then describe it visually. 

```{r message=FALSE}
pacman::p_load(tidyverse, ggthemes, nrgiR , scales)

## get the EITI entity data from resource data (only downloads once a session)

 if (!exists("eiti_entity")) {
  eiti_entity <- read_csv("https://www.resourcedata.org/dataset/7dd3c8b6-9256-4e34-9360-1519efd87407/resource/4e4462a5-6029-4ae3-a4cc-66ad6ccc6d70/download/revenues-received-by-government-agencies.csv")
}
``` 

```{r message=FALSE}
## We import the reconciliation files in excel into a dataframe (made from initially extracting all unique occurences of government agency names and names of revenue streams, matching them to clean names)
entity_reconcile <- readxl::read_excel("reconcile.xlsx", sheet = "entity_names") %>% 
  mutate(government_agency_name_clean = str_squish(government_agency_name_clean)) %>%
  distinct()

rev_code_reconcile_2 <- readxl::read_excel("reconcile.xlsx", sheet = "rev_codes") %>% 
  mutate(gfs_code_clean = str_squish(gfs_code_clean) , 
         gfs_description_clean = str_squish(gfs_description_clean) ,
         name_of_revenue_stream_clean = str_squish(name_of_revenue_stream_clean) ) %>%
  distinct()

## We filter eiti summary data for DRC specifically, we add the clean columns for the government agency names, the gfs codes, the gfs descriptions and the name of the revenue streams and then delete the original variables.
drc_eiti_entity <- eiti_entity %>% 
  filter(country == "Democratic Republic of Congo") %>% 
  left_join(., rev_code_reconcile_2, by = "name_of_revenue_stream") %>% 
  left_join(., entity_reconcile, by = "government_agency_name") %>% 
     mutate(government_agency_name = government_agency_name_clean, 
            gfs_code = gfs_code_clean, 
            gfs_description = gfs_description_clean,
            name_of_revenue_stream = name_of_revenue_stream_clean) %>%
  select ( -c( government_agency_name_clean , gfs_code_clean, gfs_description_clean ,  name_of_revenue_stream_clean)) 

```
Note: it is not possible to separate oil from mining revenues in the eiti entity dataset, is it? 

Let's visualize the data.

#### First chart: total annual contributions.

Comment: differences with the company data: more data recorded in earlier years, and grouping of oil and mining payments to government agencies.
```{r, fig.width=12}
drc_eiti_entity %>% 
  group_by(year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year, y = total_pay)) +
    geom_col() +
    theme_fivethirtyeight() +
    scale_y_continuous(labels = unit_format(accuracy = 0.1 , unit = "billion USD", scale = 1e-9, sep = " ")) +
    labs(title ="Total annual contributions according to EITI entity summary data", x = "year", y = "Cumulative payments")
```

#### Second chart: total annual contributions to main recipients

Comments:

1. Tax authority is the main recepient, closely followed by the customs authority. It confirms the revenue description of the company data.
2. DGRAD, SOEs and the Katanga provincial governments are also major recipients of extractive revenue.
3. The unassigned payments are mostly from 2008 and 2009.
```{r, fig.width=12}
drc_eiti_entity %>% 
  group_by(government_agency_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(government_agency_name = if_else(total_pay > 18e7, government_agency_name, "Other")) %>% 
  group_by(government_agency_name, year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = total_pay, fill = fct_reorder(government_agency_name, total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(accuracy = 0.1 ,unit = "billion USD", scale = 1e-9, sep = " ")) +
  labs(title ="Top recipients of oil and mining revenue according to EITI summary data", x = "year", y = "Total annual payments" , fill = "Name of revenue stream") +
  theme(
  )
```

#### Third chart: total annual contributions to main recipients, broken down by gfs description of revenue streams

Comments:

1. DGRAD is an important recipient because it manages royalties, bonus and payments delivered to the government (including profit oil from PSAs).
2. Custom payments are massive and consitute most of the custom authority large revenue.
```{r, fig.width=12}
drc_eiti_entity %>% 
  group_by(government_agency_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(government_agency_name = if_else(total_pay > 10e6, government_agency_name, "Other")) %>% 
  group_by(gfs_description) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(gfs_description = if_else(total_pay > 2e8, gfs_description, "Other")) %>% 
  group_by(government_agency_name, gfs_description) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = fct_reorder(government_agency_name, -total_pay), y = total_pay, fill = gfs_description)) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(accuracy = 0.1 ,unit = "billion USD", scale = 1e-9, sep = " ")) +
  labs(title ="Top recipients of oil and mining revenue by main gfs description according to EITI summary data", x="", y = "Cumulative payments")
```

#### Fourth chart: timing of equity sales by SOEs. It matches the company data.
```{r, fig.width=12}

drc_eiti_entity %>% 
  filter(name_of_revenue_stream == "Cession d'actifs ou parts sociales") %>%
  group_by(year, government_agency_name) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year , y = total_pay, fill = government_agency_name)) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million. USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual revenue to SOEs from equity sales according to EITI summary data", y = "Annual payments", fill ="")

```
  
###  Import production, price and cost data from SNL
 We import the files from SNL data on company production and cost per unit of production, as well as nominal prices of copper and gold
 
```{r message=FALSE}
 
## We import the files from SNL

drc_gold <- readxl::read_excel("drc_gold.xlsx")
   
drc_copper<- readxl::read_excel("drc_copper.xlsx")


nominalgoldprice <- readxl::read_xlsx("Prices_WorldGoldCouncil.xlsx", sheet = "Annual_Average", skip = 7)  %>%
  select("Name", "US dollar...2") %>%
  rename( "year" = "Name",  "goldprice" = "US dollar...2")

nominalcopperprice <- readxl::read_xlsx("LMEcopperprice.xlsx", sheet = "Sheet1", skip = 7)  %>%
  rename("year" = "...1", "copperprice" = "($/mt)") %>%
    select( year, copperprice)


## We merge the two files into one then harmonize company names: 
drc_prod <-  full_join( drc_gold, drc_copper )  %>%
    mutate("production" = as.numeric(`production`), company_name = propertyname) %>%
    left_join(., company_reconcile, by = "company_name") %>% 
     mutate(company_name = company_name_clean) %>%
    select ( - c(propertyname, id, country,company_name_clean, Additional_company_name, sector ) ) %>%
    left_join (., nominalgoldprice, by="year") %>%
    left_join(., nominalcopperprice, by="year")

## Basic description

drc_prod %>%
    filter(commodity == "Copper") %>%
    group_by(year) %>%
    summarise ( yearly_prod = sum(production, na.rm = T))  %>%
    ungroup() %>%
    ggplot (aes( year, yearly_prod)) +
    geom_bar(stat="identity")

drc_prod %>%
    filter(commodity == "Gold") %>%
    group_by(year) %>%
    summarise ( yearly_prod = sum(production, na.rm = T))  %>%
    ungroup() %>%
    ggplot (aes( year, yearly_prod)) +
    geom_bar(stat="identity")

```

```{r message=FALSE}
 
## We then merge the production / price file with the main dataset

drc_eiti <-  left_join( drc_eiti, drc_prod, by = c( "year", "company_name") ) 
   


```
  
  
###  Export excel file of clean data for non-R users:
  
```{r message=FALSE}
  
 openxlsx::write.xlsx(drc_eiti, "drc__eiti_companies.xlxs")
 openxlsx::write.xlsx(drc_eiti_entity, "drc__eiti_entity.xlxs")
 
```
 
 
 
 
  
  