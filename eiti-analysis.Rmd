---
title: "DRC - Analysis"
author: "Thomas Lassourd"
date: 'Date created: `r Sys.Date()`'
output:
  html_notebook:
    df_print: paged
    highlight: haddock
    smart: yes
    theme: readable
  html_document:
    code_folding: hide
    df_print: paged
  pdf_document: default
---
## {.tabset}

### Purpose
Cleaning and analyzing EITI data for the Democratic Republic of Congo.

We source EITI data from www.resourcedata.org, which itselfs aggregates EITI summary data in open data format shared by the international EITI secretariat here: https://eiti.org/explore-data-portal  

#### Warning: this webpage is a work in progress, shared for limited consultations only. Please keep in mind that the data may require additional cleaning. There could be errors in the EITI summary data, if not in the EITI reports themselves.The formatting of the plots is also tentative and will be refined at a later stage.

#### We welcome all comments on the data sourced, the cleaning process, and preliminary plot analysis. Please email Thomas Lassourd <tlassourd@resourcegovernance.org> or Jean Pierre Okenda <jpokenda@resourcegovernance.org>.    

```{r message=FALSE}
pacman::p_load(tidyverse, ggthemes, nrgiR , scales)

## get the EITI data from resource data (only downloads once a session)
if (!exists("eiti_company")) {
  eiti_company <- read_csv("https://www.resourcedata.org/dataset/7dd3c8b6-9256-4e34-9360-1519efd87407/resource/bba3b646-131b-47c5-9f4c-37019f896575/download/company-payments.csv")
  
}
```

Now that we have the data ready let's do some clean up.

### Cleaning

We are only interested in data from DRC. Let's narrow down the selection and clean the company names, the gfs codes, the gfs descriptions and the name of the revenue streams, using specifically made files (available upon request, or in the Github repository: https://github.com/ThomasNRGI/EITI_DRC)

```{r}
## We import the reconciliation files in excel into a dataframe (made from initially extracting all unique occurences of company names and names of revenue streams, matching them to clean names and adding a sector variable (mining vs oil))
company_reconcile <- readxl::read_excel("reconcile.xlsx", sheet = "company_names") %>% 
  mutate(company_name_clean = str_squish(company_name_clean)) %>%
  distinct()

rev_code_reconcile <- readxl::read_excel("reconcile.xlsx", sheet = "rev_codes") %>% 
  mutate(gfs_code_clean = str_squish(gfs_code_clean) , 
         gfs_description_clean = str_squish(gfs_description_clean) ,
         name_of_revenue_stream_clean = str_squish(name_of_revenue_stream_clean) ) %>%
  distinct()

## We filter eiti summary data for DRC specifically, we add the clean columns for the company names, the gfs codes, the gfs descriptions and the name of the revenue streams and then delete the original variables.
drc_eiti <- eiti_company %>% 
  filter(country == "Democratic Republic of Congo") %>% 
  left_join(., rev_code_reconcile, by = "name_of_revenue_stream") %>% 
  left_join(., company_reconcile, by = "company_name") %>% 
     mutate(company_name = company_name_clean, 
            gfs_code = gfs_code_clean, 
            gfs_description = gfs_description_clean,
            name_of_revenue_stream = name_of_revenue_stream_clean) %>%
  select ( -c( company_name_clean , gfs_code_clean, gfs_description_clean ,  name_of_revenue_stream_clean)) 

```

### Create functions for sorting observations

#### Designing the functions
In the code below we create a function that takes the tibble, the grouping variable and a threshold as its arguments. This automates the same logic that we will be repeating across different charts. 

```{r}
get_plot_data <- function(df, g_var, threshold) {
  df %>% 
    filter(sector == "Mining") %>% 
    group_by({{g_var}}) %>% 
    summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
    ungroup() %>% 
    mutate(x_var = if_else(total_pay > threshold, {{g_var}}, "Other")) %>%
    group_by(x_var) %>% 
    summarise(total_pay = sum(total_pay, na.rm = T)) %>% 
    ungroup()
}

get_plot_data_2 <- function(df, g_var, h_var, threshold) {
  df %>% 
    filter(sector == "Mining") %>% 
    group_by({{g_var}}) %>% 
    summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
    ungroup() %>% 
    mutate(x_var = if_else(total_pay > threshold, {{g_var}}, "Other")) %>%
    group_by(x_var , h_var) %>% 
    summarise(total_pay = sum(total_pay, na.rm = T)) %>% 
    ungroup()
}

```

#### Customized pie chart
Create a blank theme :

```{r}
blank_theme <- theme_minimal()+
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  plot.title=element_text(size=14, face="bold")
  )
```

### Analysis
The data is ready for some simple descriptive analysis. 

The first chart shows us the total amount of payment by year. 

Comment: large drop in mining revenue in 2016. Does it conform to EITI reports and other data points?

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year, y = total_pay)) +
    geom_col() +
    theme_fivethirtyeight() +
    scale_y_continuous(labels = unit_format(unit = "bn. USD", scale = 1e-9, sep = " ")) +
    labs(title ="Total annual contributions according to EITI summary data", x = "year", y = "Cumulative payments")
```

The second chart shows us the mining companies that pay more than a threshold of 180 million USD over the entire period covered by the database.

Comment: the majority of payments made during that period comes from 12 companies

````{r, fig.width=12}
get_plot_data( drc_eiti, company_name , threshold = 18e7) %>% 
  ggplot(data = ., mapping = aes(x = fct_reorder(x_var, -total_pay), y = total_pay)) +
  geom_col() +
  coord_flip() +
  theme_economist() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "bn. USD", scale = 1e-9, sep = " ")) +
  labs(title = "Top mining taxpayers's total contributions according to EITI reports", 
       y = "Cumulative payments") +
  theme(
    axis.title.y = element_blank()
  ) 

```

The third chart shows us the mining companies that pay more than a threshold of 180 million USD over the entire period covered by the database.

Comment: Sicomines and SEK only make it in the top 12 because of large payments in specific years, 2012 and 2014 respectively.

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 18e7, company_name, "Other")) %>% 
  group_by(company_name, year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = total_pay, fill = fct_reorder(company_name, total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "bn. USD", scale = 1e-9, sep = " ")) +
  labs(title ="Top mining taxpayers's annual contributions according to EITI summary data", x = "year", y = "Total annual payments") +
  theme(
  )
```

The fourth chart shows us the major payment types, by gfs description, that contributed more than 120 million USD over the entire period covered by the database.

Note: royalties are royalties to the State ("redevance"). Royalties to SOEs are categorized within "paid to state-owned enterprises".

Comments: 

1. Surprisingly custom payments come out first, while one would expect it to be lower, based on cash flow models.
2. Payments to SOEs is the third largest payment. 
    
```{r, fig.width=12}
get_plot_data( drc_eiti, gfs_description , threshold = 12e7) %>% 
  ggplot(aes(x = fct_reorder(x_var, -total_pay), y = total_pay)) +
  geom_col() +
  coord_flip() +
  theme_economist() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  scale_y_continuous(labels = unit_format(unit = "bn. USD", scale = 1e-9, sep = " ")) +
  labs(title ="Main revenue streams according to EITI summary data", x = "year", y = "Cumulative payments - USD")
```
```{r, fig.width=12}
get_plot_data( drc_eiti, gfs_description , threshold = 12e7) %>% 
  ggplot(aes(x = " ", y = total_pay, fill = fct_reorder(x_var, -total_pay))) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  scale_fill_grey() +  
  blank_theme +
  theme(axis.text.x=element_blank()) +
    labs(title ="Main revenue streams according to EITI summary data", x = "year", y = "Cumulative payments - USD")
```


The fifth chart shows us the major payment types, by gfs description, that contributed more than 120 million USD over the entire period covered by the database, on an annual basis.

Comments:

1. Custom duties are really high from 2013 to 2015.
2. Large bonus payment in 2012 (Sicomines?)
3. No taxes on payroll in 2016 - check the data

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(gfs_description) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(gfs_description = if_else(total_pay > 12e7, gfs_description, "Other")) %>% 
  group_by(gfs_description, year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = total_pay, fill = fct_reorder(gfs_description, total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "bn. USD", scale = 1e-9, sep = " ")) +
  labs(title = str_wrap("Top mining taxpayers's annual contributions according to EITI summary data"), x = "year", y = str_wrap("Total annual payments"))
```



The sixth chart shows us the major gfs description of the payments of the mining companies that pay more than a threshold of 180 million USD over the entire period covered by the database.

Comments:

1. MUMI, KCC, TFM and Kibali pay a lot of custom duties: investigate
2. KCC, Metalkol, TFM, Ruahsi, Boss, and MUMI pay significant amount to SOEs.
3. Very large bonus payments from Sicomines and Frontier.
4. Very little royalties paid by Metalkol and Sicomines. 

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 18e7, company_name, "Other")) %>% 
  group_by(gfs_description) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(gfs_description = if_else(total_pay > 12e7, gfs_description, "Other")) %>% 
  group_by(company_name, gfs_description) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = fct_reorder(company_name, -total_pay), y = total_pay, fill = gfs_description)) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "bn. USD", scale = 1e-9, sep = " ")) +
  labs(title ="Top mining taxpayers's total contributions by main gfs description according to EITI summary data", y = "Cumulative payments")
```

The seventh chart shows us the mining companies that pay more than a threshold of 20 million USD of customs payments over the entire period covered by the database.

Comments:

1.  Confirms that KCC, MUMI, TFM and Kibali have paid very large sums in custom duties. Need to look into it. Possible explanations: fuel imports and other inputs?

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining" ,
         gfs_description == "Customs and other import duties"
         ) %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 1e7, company_name, "Other")) %>% 
  group_by(company_name, gfs_description) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = fct_reorder(company_name, -total_pay), y = total_pay, fill = gfs_description)) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Top mining payers of custom duties according to EITI summary data", y = "Cumulative payments")
```

The eigth and ninth charts show us the details of the SOE payments by company and by year.

Comments:

1. Royalties are the first reveue flow to SOEs, followed by Pas de Porte (bonuses)
2. KCC is by far the largest payer to SOEs
3. PAs de porte were the highest between 2010 and 2012
4. Frais de consultance only show up from TFM and MUMI. But are very regular payments between 2013 and 2016. 
5. Fonds pour la vente des scories (payments to GCM for deposit sales) only show up from STL and Rubamin. But are significant payment from 2013 to 2016.
6. SOEs receive annually between 60 and 180 million USD in total payments from mining companies.

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining" ,
         gfs_description == "Delivered/paid to state-owned enterprise(s)"
         ) %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 1e7, company_name, "Other")) %>% 
  group_by(company_name, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = fct_reorder(company_name, -total_pay), y = total_pay, fill = name_of_revenue_stream)) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Top mining payers to SOEs according to EITI summary data", y = "Cumulative payments")
```


```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining" ,
         gfs_description == "Delivered/paid to state-owned enterprise(s)"
         ) %>% 
  group_by(year, name_of_revenue_stream) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
    ggplot(aes(x = year , y = total_pay , fill = fct_reorder(name_of_revenue_stream, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  labs(title ="Annual payments to SOEs according to EITI summary data", y = "Annual payments")
```

The tenth chart in facet wrap shows us the major gfs description of the payments of the mining companies that pay more than a threshold of 180 million USD each year covered by the database.

Comments:

1. KCC's payments almost stop in 2016
2. Comapnies that have a "normal" payment profile over time: Boss, MMG, Ruashi, Kibali, Frontier.
3. TFM: exceptionnally large income tax payment in 2015
4. Kipoi: exceptionnally large income tax payment in 2014
5. MUMI: exceptionnally large income tax payment in 2011 and 2015
6. Meltalkol: exceptionnally large income tax payment in 2016

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 18e7, company_name, "Other")) %>% 
  group_by(gfs_description) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(gfs_description = if_else(total_pay > 12e7, gfs_description, "Other")) %>% 
  group_by(company_name, gfs_description , year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = total_pay, fill = fct_reorder(gfs_description, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  facet_wrap(~str_wrap(company_name)) +
  labs(title ="Top mining taxpayers's total contributions by main gfs description according to EITI summary data", y = "Total annual payments")
```


The eleventh chart in facet wrap shows us how much payments are made in each gfs category each year by the mining companies that pay more than a threshold of 180 million USD each year covered by the database.

Comments:

1. Why did Mutanda pay so much income tax as a one-off payment in 2012?
2. No taxes on payroll in 2016
3. Metalkol suddenly starts paying income tax in 2016
4. Taxes on exports are just a little lower than royalties, but have no basis in the mining code
5. Custom duties in 2013-2015 seem disproportionate. 
6. Taxes on income show a strange pattern, very dependent on individual company payments.

```{r, fig.width=12}
drc_eiti %>% 
  filter(sector == "Mining") %>% 
  group_by(company_name) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(company_name = if_else(total_pay > 18e7, company_name, "Other")) %>% 
  group_by(gfs_description) %>% 
  mutate(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(gfs_description = if_else(total_pay > 12e7, gfs_description, "Other")) %>% 
  group_by(company_name, gfs_description , year) %>% 
  summarise(total_pay = sum(value_reported_as_USD, na.rm = T)) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = total_pay, fill = fct_reorder(company_name, -total_pay))) +
  geom_bar(stat = "identity" , colour="black") +
  scale_fill_manual(values = c(nrgi_colors(),"black", "red", "blue", "purple" , "navy" , "orange"), na.value = nrgi_colors()[5]) +
  nrgi_theme() + 
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 30)) +
  scale_y_continuous(labels = unit_format(unit = "million USD", scale = 1e-6, sep = " ")) +
  facet_wrap(~gfs_description) +
  labs(title ="Annual payments by gfs description of the top mining taxpayers naccording to EITI summary data", y = "Total annual payments")
```

### Next steps

We will look at payments to different government agencies - especially for SOE payments. This requires to look at the EITI summary data from the perspective of collecting agencies. 